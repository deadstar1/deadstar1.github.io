<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>Oauth security misconfiguration on facebook</title>
  <meta name="description" content="facebook oauth flaws">

  <!-- CSS files -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
  <link rel="stylesheet" href="http://192.168.33.177:4000//css/main.css">
  <link rel="stylesheet" href="http://192.168.33.177:4000//css/responsivediv.css">

  <link rel="canonical" href="http://192.168.33.177:4000//articles/2016-05/Ouath_bug_facebook">
  <link rel="alternate" type="application/rss+xml" title="Blog BLog" href="http://192.168.33.177:4000/ /feed.xml " />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="http://192.168.33.177:4000//favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="http://192.168.33.177:4000//favicon.ico">

</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
         

<div class="cover-card table-cell table-middle">
  
  <img src="http://192.168.33.177:4000//img/profile.jpg" alt="this is me!" class="avatar">
  
  <a href="http://192.168.33.177:4000//" class="author_name">Adrian Belen</a>
  <span class="author_job">WEB APPLICATION SECURITY ENTHUSIAST, BREAKING THINGS FOR FUN & profit :D</span>
  <span class="author_bio mbm"></span>
  <nav class="nav">
    <ul class="nav-list">
       
      <li class="nav-item">
        <a href="http://192.168.33.177:4000//about me ">about me</a>
        <span>/</span>
      </li>
      
      <li class="nav-item">
        <a href="http://192.168.33.177:4000//archive">archive</a>
        <span>/</span>
      </li>
      
      <li class="nav-item">
        <a href="http://192.168.33.177:4000//categories">categories</a>
      </li>
     
    </ul>
  </nav>
  <div class="social-links">
  <ul>
    
    <li><a href="http://twitter.com/nukesec" class="social-link-item" target="_blank"><i class="fab fa-twitter-square"></i></a></li>
    
    
    
    
    
    
    <li><a href="http://github.com/deadstar1" class="social-link-item" target="_blank"><i class="fab fa-github"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    <li>
      <a title='Hackerone' href="http://hackerone.com/adrianbelen" class="social-link-item" target="_blank">
        <svg width="20px" height="15px" viewBox="0 0 39 74" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <!-- Generator: Sketch 3.4.2 (15855) - http://www.bohemiancoding.com/sketch -->
    <title>Untitled 3</title>
    <desc>Created with Sketch.</desc>
    <defs>
        <path id="path-1" d="M0.06,3.60329081 C0.212928399,2.89925466 0.657587482,2.30266801 1.387,1.823 C2.307,1.223 3.497,0.915 4.958,0.915 C6.357,0.915 7.547,1.223 8.535,1.823 C9.523,2.44 10.014,3.219 10.014,4.183 L10.014,70.051 C10.014,70.887 9.499,71.652 8.486,72.35 C7.467,73.056 6.295,73.407 4.958,73.407 C3.559,73.407 2.387,73.056 1.436,72.35 C0.673931664,71.7899832 0.215600576,71.1951631 0.06,70.5544658 L0.06,3.60329081 L0.06,3.60329081 Z"></path>
        <path id="path-3" d="M0.787,9.392 C0.187,9.954 -0.071,10.807 0.04,11.974 C0.143,13.13 0.677,14.23 1.623,15.268 C2.573,16.313 3.635,16.968 4.85,17.246 C6.046,17.517 6.955,17.369 7.555,16.813 L12.857,13.506 L12.857,43.051 C12.857,43.887 13.317,44.646 14.249,45.35 C15.158,46.056 16.324,46.407 17.723,46.407 C19.122,46.407 20.33,46.056 21.343,45.35 C22.361,44.646 22.871,43.887 22.871,43.051 L22.871,3.329 C22.871,2.365 22.374,1.587 21.392,0.988 C20.41,0.376 19.189,0.079 17.723,0.079 C16.262,0.079 15.09,0.376 14.194,0.988 L0.787,9.392 L0.787,9.392 Z"></path>
    </defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
        <g id="HackerOne---short" sketch:type="MSLayerGroup">
            <g id="Page-1">
                <g id="Group-3">
                    <mask id="mask-2" sketch:name="Clip 2" fill="white">
                        <use xlink:href="#path-1"></use>
                    </mask>
                    <g id="Clip-2"></g>
                    <path d="M0.06,0.8 L10.02,0.8 L10.02,73.52 L0.06,73.52 L0.06,0.8 Z" id="Fill-1" fill="#8d7edc" sketch:type="MSShapeGroup" mask="url(#mask-2)"></path>
                </g>
                <g id="Group-6" transform="translate(16.000000, 27.000000)">
                    <mask id="mask-4" sketch:name="Clip 5" fill="white">
                        <use xlink:href="#path-3"></use>
                    </mask>
                    <g id="Clip-5"></g>
                    <path d="M0.02,-0.04 L22.94,-0.04 L22.94,46.52 L0.02,46.52 L0.02,-0.04 Z" id="Fill-4" fill="#8d7edc" sketch:type="MSShapeGroup" mask="url(#mask-4)"></path>
                </g>
            </g>
        </g>
    </g>
</svg>
      </a>
    </li>
    
    
    
    <li>
      <a title='Bugcrowd' href="http://bugcrowd.com/adrianbelen" class="social-link-item" target="_blank">
        <?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="20px" height="17px" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg">
<path fill="#8d7edc" d=" M 0.00 0.00 L 100.00 0.00 L 100.00 100.00 L 0.00 100.00 L 0.00 0.00 Z" />
<path fill="#fffffe" d=" M 26.11 19.79 C 30.62 19.82 35.19 19.42 39.65 20.20 C 41.19 21.24 42.07 23.05 41.93 24.91 C 42.00 30.37 41.96 35.84 41.87 41.31 C 49.00 32.65 64.62 33.90 70.17 43.67 C 75.42 52.52 75.40 64.75 69.23 73.14 C 63.04 81.81 48.35 83.06 41.46 74.61 C 41.33 76.19 41.24 77.77 41.21 79.35 C 37.86 79.32 34.44 79.91 31.14 79.04 C 31.28 62.33 31.33 45.60 31.12 28.88 C 29.45 28.81 27.79 28.71 26.12 28.58 C 26.07 25.65 26.09 22.72 26.11 19.79 Z" />
<path fill="#8d7edc" d=" M 48.25 45.30 C 53.43 42.87 59.98 45.70 61.96 51.01 C 64.53 57.41 63.73 66.39 57.33 70.25 C 52.22 73.40 45.03 70.69 42.92 65.16 C 40.21 58.56 40.99 48.63 48.25 45.30 Z" />
</svg>

      </a>
    </li>
    
  </ul>
</div>

</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <div class="back-home">
  <a href="http://192.168.33.177:4000//">< back Home.</a>
</div>



<div id="post">
  <header class="post-header">
    <h1 title="Oauth security misconfiguration on facebook">Oauth security misconfiguration on facebook</h1>
    <span class="post-meta">
      <span class="post-date">
        14 MAY 2016
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    3 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <blockquote>
  <p>OAuth is an open standard for authorization, commonly used as a way for Internet users to log in to third party websites using their Microsoft, Google, Facebook, Twitter, One Network etc. accounts without exposing their password.</p>
</blockquote>

<p>Misconfigured OAuth setting could lead to Account take-over, CSRF attack and Token leakage(code and access token). Visit http://www.oauthsecurity.com for more list of OAUTH attacks. This blog post is about facebook Misconfigured OAuth setting that has a security impact on its users. The bugs were reported, and Facebook had mitigated the bugs Before I disclosed it.</p>

<h2 id="quick-jump">Quick Jump</h2>
<ul>
  <li><a href="#x01-bypass-moves-oauth-2-redirecturi">Bypass moves oauth 2 redirect_uri</a></li>
  <li><a href="#x02---leak-mailchimp-accesstoken-via-open-redirector">Leak mailchimp access_token via open redirector</a></li>
  <li><a href="#x03---cross-site-request-forgery-on-oauth-clientsmodifies-victims-spotify-playlist-via-csrf">Cross-site request forgery on OAuth Clients(Modifies Victim’s spotify playlist Via CSRF)</a></li>
</ul>

<h2 id="x01-bypass-movesfacebook-aquisition-oauth-2-redirecturi">0x01-Bypass moves(Facebook Aquisition) oauth 2 redirect_uri</h2>

<p>I created an OAuth application which registered redirect_url is https://www.google.com/,  so it authorization_uri must not be</p>

<div class="highlight"><pre><code class="language-text" data-lang="text">https://api.moves-app.com/oauth/v1/authorize?response_type=code&amp;client_id=&lt;client_id&gt;&amp;scope=&lt;scope&gt;&amp;redirect_uri=https//yahoo.com

https://api.moves-app.com/oauth/v1/authorize?response_type=code&amp;client_id=&lt;client_id&gt;&amp;scope=&lt;scope&gt;&amp;redirect_uri=facebook.com</code></pre></div>

<p>But when I changed the redirect_uri to this <code>https://www.google.com.ph</code> (appends .ph suffix domain on moves redirect_uri).  Surprisingly, it works :) Besides the redirect_uri can also be bypassed via <code>/../../</code>. for example, if the redirect_uri is <code>https://www.google.com/app/url</code> change the redirect_uri to  ` https://www.google.com/app/url/../../ `</p>

<p>The flaw could be used to leak access_token of victim user to attacker’s domain.</p>

<p>According to the OAuth 2 documentation, the redirect_uri must be equal to registered redirect_uri
http://tools.ietf.org/html/rfc6819#page-62</p>

<h2 id="x02---leak-mailchimp-accesstoken-via-open-redirector">0x02 - Leak mailchimp access_token via open redirector</h2>

<p>Facebook sends email notification about saved link of the user every week. If the user clicks any link in his email notification, the browser will be redirected to facebook.com then redirect to the original link without the use of <a href="https://m.facebook.com/notes/facebook-security/link-shim-protecting-the-people-who-use-facebook-from-malicious-urls/10150492832835766/">Facebook linkshim</a>. It seems this is an Open redirector bug. </p>

<div class="highlight"><pre><code class="language-text" data-lang="text">https://www.facebook.com/saved/redirect/?user_id=100000169908395&amp;object_id=1007549219269324&amp;surface=saved_email_reminder&amp;mechanism=clickable_content</code></pre></div>
<p> The vulnerable parameter is <code>object_id</code>, we can get the <code>object_id</code> in https://www.facebook.com/saved/?cref=38 when we use using this endpoint </p>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://www.facebook.com/timeline/app/collection/item/curation/(used to delete saved link).</code></pre></div>

<h3 id="exploitation">Exploitation</h3>

<p>In the exploitation part, I used the open
redirect of facebook to leak access_token of MailChimp OAuth. Facebook Ads
Manager <a href="https://www.facebook.com/ads/manage/?act=109060336">https://www.facebook.com/ads/manage/?act=109060336</a> can import
MailChimp  customer data by using OAuth 2. I have found there is no
restriction of <em>redirect_uri</em> value in MailChimp OAuth (Covert Open redirect), so we can abuse the
open redirect vulnerability of facebook to leak the access_token of the victim user.</p>

<p><strong>Step of Reproduction</strong></p>

<ul>
  <li>Go to your profile then post a link (link to malicious site)</li>
  <li>save the link by clicking the dropdown button on upper right of a post then click the <code>save link</code>.</li>
  <li>now you need to use your <code>user_id</code> and the <code>object_id</code> of the link.</li>
  <li>The final open redirect PoC must be</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://www.facebook.com/saved/redirect/?user_id=100000169908395&amp;object_id=910603298986679&amp;surface=saved_email_reminder&amp;mechanism=clickable_content</code></pre></div>

<ul>
  <li>Use the <code>final open redirect PoC</code> as <code>redirect_uri</code> of mailchimp oauth 2 
i.e.</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://login.mailchimp.com/oauth2/authorize?response_type=token&amp;client_id=112041070777&amp;redirect_uri=https%3A%2F%2Fwww.facebook.com%2Fsaved%2Fredirect%2F%3Fuser_id%3D100000169908395%26object_id%3D910603298986679%26surface%3Dsaved_email_reminder%26mechanism%3Dclickable_content</code></pre></div>

<!--**video demo:** [facebook_oauth bug_x264_Segment_0_x264.mp4](https://trello-attachments.s3.amazonaws.com/55f04e12c197829570241a4c/57370b657cf0a4155fa203af/df77f826434f5d54984d70296dba29dd/facebook_oauth_bug_x264_Segment_0_x264.mp4)
-->
<p><strong>Video Demostration</strong></p>

<div class="video-container">
<iframe width="480" height="360" src="https://www.youtube.com/embed/t3LUQTcJ-ZA" frameborder="0"> </iframe>
</div>

<h2 id="x03---cross-site-request-forgery-on-oauth-clientsmodifies-victims-spotify-playlist-via-csrf">0x03 - Cross-site request forgery on OAuth Clients(Modifies Victim’s spotify playlist Via CSRF),</h2>

<p>Facebook user can embed a spotify playlist on his facebook timeline by posting a spotify link such as this one</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://play.spotify.com/album/31d6jaMCDe28dAmBv63bBY,</code></pre></div>

<p>on that embedded playlist, user has an option to add that playlist on his spotify account by using oauth 2, facebok uses spotify oauth 2 to do that action.</p>

<p>I have found that facebook uses the spotify oauth 2 without using the state parameter of the oauth, according to OAuth 2.0 Threat Model and Security Considerations and spotify oauth documentation, the state parameter is used to prevent CSRF attack on oauth(see http://tools.ietf.org/html/rfc6819#section-3.6 and https://developer.spotify.com/web-api/authorization-guide/ -‘Your application requests authorization’). Because there is not csrf protection malicious user could make a csrf attack against facebook that updates victim’s playlist.</p>

<h3 id="hack-steps">Hack Steps</h3>

<ul>
  <li>post the link on your timeline</li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://play.spotify.com/album/31d6jaMCDe28dAmBv63bBY)</code></pre></div>
<p>to generate the embbed playlist then copy the authorization url of spotify. This is  the authorization url of spotify that uses by facebook</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://accounts.spotify.com/en/authorize?client_id=9cc4aaeb43f24b098cff096385f00233&amp;response_type=code&amp;redirect_uri=https%3A%2F%2Fwww.facebook.com%2Fmusic%2Fspotify%2Fauth%2F&amp;scope=user-library-modify+user-library-read&amp;show_dialog=true</code></pre></div>

<ul>
  <li>now removed the <code>&amp;show_dialog=true</code> parameter of the authorization url so the final url will be </li>
</ul>
<div class="highlight"><pre><code class="language-text" data-lang="text">https://accounts.spotify.com/en/authorize?client_id=9cc4aaeb43f24b098cff096385f00233&amp;response_type=code&amp;redirect_uri=https%3A%2F%2Fwww.facebook.com%2Fmusic%2Fspotify%2Fauth%2F&amp;scope=user-library-modify+user-library-read</code></pre></div>

<ul>
  <li>If the victim visits the PoC link, CSRF will be triggered</li>
</ul>

<p><strong>video Demonstration</strong>
csrfonouathfacebookandspotify.mp4?dl=0</p>

  </article>
</div>

<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href='https://twitter.com/intent/tweet?text=http://maradrianbelen.com/articles/2016-05/Ouath_bug_facebook @nukesec' class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://maradrianbelen.com/articles/2016-05/Ouath_bug_facebook @nukesec'" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://maradrianbelen.com/articles/2016-05/Ouath_bug_facebook" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=http://maradrianbelen.com/articles/2016-05/Ouath_bug_facebook" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=http://maradrianbelen.com/articles/2016-05/Ouath_bug_facebook" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div><!-- end share-buttons -->


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'adrianswebsecurityblog';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



        <footer>
  &copy; 2019 Adrian Belen. Powered by <a href="http://jekyllrb.com/">Jekyll</a>,  made with <i class="fa fa-heart heart-icon"></i>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="http://192.168.33.177:4000//js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="http://192.168.33.177:4000//js/main.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.1/anchor.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75403295-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="text/javascript">
 // anchors.options.icon='';
  anchors.add('h2');
</script>


</body>

<!-- some random motos here-->
  <script type="text/javascript">
    //list of motos
    var motos = [
    //"In the end, people will judege you anyway, so don't live your life impressing others - live your life impressing yourself",
    //"Live life to express, not to impress",
    "<b>Success</b> is the ability to go from one failure to another with no loss of enthusiasm."
    //"<b>IF</b> no mistake have you made, yet losing you are... a different game you should play </br> - Master Yoda"
    //"<b>No free quote for the day!</b>",
    //"Your dream doesn't have an expiration date. Take a deep breath, and try again.",
    //"There is nothing wrong with being mediocre, there is something wrong with not wanting to improve past mediocrity."
    ];
    var len =motos.length
    var x = Math.floor((Math.random() * len ) + 1);
    document.getElementsByClassName('author_bio')[0].innerHTML='"'+motos[x-1] + '" </br> -Sir Winston Churchill';
    console.log('selected moto:' + motos[x-1]);
    console.log('moto count: ' + motos.length );
    console.log('random ' + x-1)
  </script>
</html>
